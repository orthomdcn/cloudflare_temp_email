name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v3
        name: Install pnpm
        id: pnpm-install
        with:
          version: 8
          run_install: false

      - name: Deploy Backend for ${{ github.ref_name }}
        run: |
          # --- æ£€æŸ¥å¿…éœ€çš„ Secrets ---
          MANDATORY_SECRETS=(
            "DOMAINS"
            "JWT_SECRET"
            "ADMIN_PASSWORDS"
            "DB_DATABASE_NAME"
            "DB_DATABASE_ID"
          )
          for secret in "${MANDATORY_SECRETS[@]}"; do
            # ä½¿ç”¨é—´æ¥å˜é‡å¼•ç”¨æ¥è·å– secret çš„å€¼
            value=$(eval echo \$"$secret")
            if [ -z "$value" ]; then
              echo "âŒ Error: Mandatory secret $secret is not set. Please add it to your repository's Actions secrets."
              exit 1
            fi
          done
          echo "âœ… All mandatory secrets are set."

          # --- åŠ¨æ€ç”Ÿæˆ wrangler.toml ---
          cd worker/

          # å†™å…¥ wrangler.toml çš„é™æ€éƒ¨åˆ†å’Œå¿…éœ€çš„å˜é‡
          cat << EOF > wrangler.toml
          name = "cloudflare_temp_email"
          main = "src/worker.ts"
          compatibility_date = "2025-04-01"
          compatibility_flags = [ "nodejs_compat" ]

          # å¿…éœ€çš„ D1 æ•°æ®åº“ç»‘å®š
          [[d1_databases]]
          binding = "DB"
          database_name = "${{ secrets.DB_DATABASE_NAME }}"
          database_id = "${{ secrets.DB_DATABASE_ID }}"

          [vars]
          # å¿…éœ€çš„å˜é‡
          DOMAINS = '${{ secrets.DOMAINS }}'
          JWT_SECRET = "${{ secrets.JWT_SECRET }}"
          ADMIN_PASSWORDS = '${{ secrets.ADMIN_PASSWORDS }}'
          EOF
          echo "Generated wrangler.toml with mandatory variables."

          # --- åŠ¨æ€æ·»åŠ å¯é€‰å˜é‡ ---
          # å°†æ‰€æœ‰ secrets è½¬æ¢ä¸º JSON å¹¶ç­›é€‰å‡ºå¯é€‰å˜é‡
          # æ³¨æ„ï¼šè¯·ä¸è¦åœ¨ secret çš„åå­—ä¸­ä½¿ç”¨ `"` æˆ– `\` ç­‰ç‰¹æ®Šå­—ç¬¦
          echo '${{ toJSON(secrets) }}' | jq -r 'keys[]' | while read -r secret; do
            # æ’é™¤å¿…éœ€å˜é‡å’Œ Github è‡ªåŠ¨æ·»åŠ çš„ GITHUB_TOKEN
            if [[ ! " ${MANDATORY_SECRETS[*]} " =~ " ${secret} " ]] && [[ "$secret" != "GITHUB_TOKEN" ]] && [[ "$secret" != CLOUDFLARE* ]]; then
              value=$(eval echo \$"$secret")
              # åªæœ‰å½“ secret çš„å€¼ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ 
              if [ -n "$value" ]; then
                echo "Found optional secret: $secret, adding to wrangler.toml."
                # åˆ¤æ–­å€¼æ˜¯å¦ä¸ºå¸ƒå°”å€¼æˆ–çº¯æ•°å­—ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç”¨åŒå¼•å·åŒ…è£¹
                if [[ "$value" == "true" ]] || [[ "$value" == "false" ]] || [[ "$value" =~ ^[0-9]+$ ]]; then
                  echo "$secret = $value" >> wrangler.toml
                # åˆ¤æ–­å€¼æ˜¯å¦ä¸º JSON æ•°ç»„æˆ–å¯¹è±¡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç”¨å•å¼•å·åŒ…è£¹
                elif [[ "$value" == "["* || "$value" == "{"* ]]; then
                    echo "$secret = '$value'" >> wrangler.toml
                else
                  echo "$secret = \"$value\"" >> wrangler.toml
                fi
              fi
            fi
          done
          
          echo "--- Generated wrangler.toml content ---"
          cat wrangler.toml
          echo "---------------------------------------"

          # --- åç»­çš„å®‰è£…å’Œéƒ¨ç½²æ­¥éª¤ ---
          # (è¿™éƒ¨åˆ†ä¸æ‚¨ä¹‹å‰çš„è„šæœ¬ä¿æŒä¸€è‡´)
          export use_worker_assets=${{ secrets.USE_WORKER_ASSETS }}
          if [ -n "$use_worker_assets" ]; then
            cd ../frontend/
            pnpm install --no-frozen-lockfile
            if [ -n "${{ secrets.USE_WORKER_ASSETS_WITH_TELEGRAM }}" ]; then
              pnpm build:telegram:pages
            else
              pnpm build:pages
            fi
            cd ../worker/
          fi
          
          export use_mail_wasm_parser=${{ secrets.BACKEND_USE_MAIL_WASM_PARSER }}
          pnpm install --no-frozen-lockfile
          if [ -n "$use_mail_wasm_parser" ]; then
            pnpm add mail-parser-wasm-worker
            git apply ../.github/config/mail-parser-wasm-worker.patch
          fi

          if [ "${{ secrets.DEBUG_MODE }}" = "true" ]; then
            pnpm run deploy
          else
            pnpm run deploy
          fi
          echo "ğŸš€ Deployment successful for tag ${{ github.ref_name }}"
        env:
          # å°†æ‰€æœ‰ secrets ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ç»™è„šæœ¬
          ${{ toJSON(secrets) }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
