# 这个 'name' 字段必须在文件的最顶行，且没有任何缩进。
# 它决定了在 Github Actions 页面上显示的名字。
name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  # 这一行让你可以手动点击 "Run workflow" 按钮
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v3
        name: Install pnpm
        id: pnpm-install
        with:
          version: 8
          run_install: false

      - name: Deploy Backend for ${{ github.ref_name }}
        # 使用 env 关键字将所有 secrets 注入到这个步骤的环境变量中
        env:
          ${{ toJSON(secrets) }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # --- 1. 检查必需的 Secrets ---
          MANDATORY_SECRETS=(
            "DOMAINS"
            "JWT_SECRET"
            "ADMIN_PASSWORDS"
            "DB_DATABASE_NAME"
            "DB_DATABASE_ID"
          )
          for secret in "${MANDATORY_SECRETS[@]}"; do
            # 直接从环境变量读取
            if [ -z "${!secret}" ]; then
              echo "❌ Error: Mandatory secret $secret is not set. Please add it to your repository's Actions secrets."
              exit 1
            fi
          done
          echo "✅ All mandatory secrets are set."

          # --- 2. 动态生成 wrangler.toml ---
          cd worker/

          # 写入 wrangler.toml 的静态部分和必需的变量
          cat << EOF > wrangler.toml
          name = "cloudflare_temp_email"
          main = "src/worker.ts"
          compatibility_date = "2025-04-01"
          compatibility_flags = [ "nodejs_compat" ]

          [[d1_databases]]
          binding = "DB"
          database_name = "${DB_DATABASE_NAME}"
          database_id = "${DB_DATABASE_ID}"

          [vars]
          DOMAINS = '${DOMAINS}'
          JWT_SECRET = "${JWT_SECRET}"
          ADMIN_PASSWORDS = '${ADMIN_PASSWORDS}'
          EOF
          echo "Generated wrangler.toml with mandatory variables."

          # --- 3. 动态添加可选变量 ---
          # 将所有 secrets 转换为 JSON 并筛选出可选变量
          echo '${{ toJSON(secrets) }}' | jq -r 'keys[]' | while read -r secret; do
            # 排除必需变量和 Github 自动添加的 GITHUB_TOKEN 及 Cloudflare 的 Token
            if [[ ! " ${MANDATORY_SECRETS[*]} " =~ " ${secret} " ]] && [[ "$secret" != "GITHUB_TOKEN" ]] && [[ ! "$secret" == CLOUDFLARE_* ]]; then
              value="${!secret}"
              if [ -n "$value" ]; then
                echo "Found optional secret: $secret, adding to wrangler.toml."
                # 判断值是否为布尔值或纯数字，如果不是，则用双引号包裹
                if [[ "$value" == "true" ]] || [[ "$value" == "false" ]] || [[ "$value" =~ ^-?[0-9]+(\.[0-9]+)?$ ]]; then
                  echo "$secret = $value" >> wrangler.toml
                # 判断值是否为 JSON 数组或对象，如果是，则用单引号包裹
                elif [[ "$value" == "["* || "$value" == "{"* ]]; then
                  echo "$secret = '$value'" >> wrangler.toml
                else
                  # 其他所有情况都作为字符串处理，用双引号包裹
                  # 注意：这里需要转义 value 中的双引号
                  escaped_value=$(echo "$value" | sed 's/"/\\"/g')
                  echo "$secret = \"$escaped_value\"" >> wrangler.toml
                fi
              fi
            fi
          done

          echo "--- Generated wrangler.toml content ---"
          cat wrangler.toml
          echo "---------------------------------------"

          # --- 4. 后续的安装和部署步骤 ---
          if [ -n "$USE_WORKER_ASSETS" ]; then
            cd ../frontend/
            pnpm install --no-frozen-lockfile
            if [ -n "$USE_WORKER_ASSETS_WITH_TELEGRAM" ]; then
              pnpm build:telegram:pages
            else
              pnpm build:pages
            fi
            cd ../worker/
          fi

          pnpm install --no-frozen-lockfile
          if [ -n "$BACKEND_USE_MAIL_WASM_PARSER" ]; then
            pnpm add mail-parser-wasm-worker
            git apply ../.github/config/mail-parser-wasm-worker.patch
          fi

          if [ "$DEBUG_MODE" = "true" ]; then
            pnpm run deploy
          else
            pnpm run deploy
          fi
          echo "🚀 Deployment successful for tag ${{ github.ref_name }}"
