name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v3
        name: Install pnpm
        with:
          version: 8
          run_install: false

      - name: Build and Deploy Backend
        env:
          # å°†æ‰€æœ‰ secrets æ³¨å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œä»¥ä¾¿è„šæœ¬å¯ä»¥è®¿é—®
          ${{ toJSON(secrets) }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # --- 1. æ£€æŸ¥å¿…éœ€çš„ Secrets ---
          # è¿™ä¸ªæ£€æŸ¥ç°åœ¨æ›´åŠ ç›´æ¥å’Œå¯é 
          if [ -z "${{ secrets.DOMAINS }}" ] || \
             [ -z "${{ secrets.JWT_SECRET }}" ] || \
             [ -z "${{ secrets.ADMIN_PASSWORDS }}" ] || \
             [ -z "${{ secrets.DB_DATABASE_NAME }}" ] || \
             [ -z "${{ secrets.DB_DATABASE_ID }}" ]; then
            echo "âŒ é”™è¯¯ï¼šä¸€ä¸ªæˆ–å¤šä¸ªå¿…éœ€çš„ secret æœªè®¾ç½®æˆ–ä¸ºç©ºï¼"
            echo "è¯·åœ¨ä»“åº“çš„ 'Settings' -> 'Secrets and variables' -> 'Actions' ä¸­æ£€æŸ¥ä»¥ä¸‹å¿…éœ€çš„ secrets æ˜¯å¦éƒ½å·²æ­£ç¡®è®¾ç½®ï¼š"
            echo "- DOMAINS"
            echo "- JWT_SECRET"
            echo "- ADMIN_PASSWORDS"
            echo "- DB_DATABASE_NAME"
            echo "- DB_DATABASE_ID"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰å¿…éœ€çš„ secret éƒ½å·²è®¾ç½®ã€‚"

          # --- 2. åŠ¨æ€ç”Ÿæˆ wrangler.toml ---
          cd worker/

          # å†™å…¥ wrangler.toml çš„é™æ€éƒ¨åˆ†å’Œå¿…éœ€çš„å˜é‡
          cat << EOF > wrangler.toml
          name = "cloudflare_temp_email"
          main = "src/worker.ts"
          compatibility_date = "2025-04-01"
          compatibility_flags = [ "nodejs_compat" ]

          [[d1_databases]]
          binding = "DB"
          database_name = "${{ secrets.DB_DATABASE_NAME }}"
          database_id = "${{ secrets.DB_DATABASE_ID }}"

          [vars]
          DOMAINS = '${{ secrets.DOMAINS }}'
          JWT_SECRET = "${{ secrets.JWT_SECRET }}"
          ADMIN_PASSWORDS = '${{ secrets.ADMIN_PASSWORDS }}'
          EOF

          # --- 3. åŠ¨æ€æ·»åŠ å¯é€‰å˜é‡ ---
          # æ­¤å¤„ç›´æ¥ä½¿ç”¨ env ä¸Šä¸‹æ–‡ï¼Œæ›´åŠ ç¨³å®š
          MANDATORY_SECRETS_LIST="DOMAINS JWT_SECRET ADMIN_PASSWORDS DB_DATABASE_NAME DB_DATABASE_ID GITHUB_TOKEN CLOUDFLARE_ACCOUNT_ID CLOUDFLARE_API_TOKEN"
          
          echo '${{ toJSON(secrets) }}' | jq -r 'keys[]' | while read -r secret_key; do
            if [[ ! " $MANDATORY_SECRETS_LIST " =~ " ${secret_key} " ]]; then
              # ä»ç¯å¢ƒå˜é‡ä¸­è·å– secret çš„å€¼
              value="${!secret_key}"
              if [ -n "$value" ]; then
                echo "æ‰¾åˆ°å¯é€‰ secret: $secret_key, æ­£åœ¨æ·»åŠ åˆ° wrangler.toml..."
                if [[ "$value" == "true" ]] || [[ "$value" == "false" ]] || [[ "$value" =~ ^-?[0-9]+(\.[0-9]+)?$ ]]; then
                  echo "$secret_key = $value" >> wrangler.toml
                elif [[ "$value" == "["* || "$value" == "{"* ]]; then
                  echo "$secret_key = '$value'" >> wrangler.toml
                else
                  escaped_value=$(echo "$value" | sed 's/"/\\"/g')
                  echo "$secret_key = \"$escaped_value\"" >> wrangler.toml
                fi
              fi
            fi
          done

          echo "--- ç”Ÿæˆçš„ wrangler.toml å†…å®¹å¦‚ä¸‹ ---"
          cat wrangler.toml
          echo "------------------------------------"

          # --- 4. å®‰è£…ä¾èµ–å¹¶éƒ¨ç½² ---
          if [ -n "${USE_WORKER_ASSETS}" ]; then
            cd ../frontend/
            pnpm install --no-frozen-lockfile
            if [ -n "${USE_WORKER_ASSETS_WITH_TELEGRAM}" ]; then
              pnpm build:telegram:pages
            else
              pnpm build:pages
            fi
            cd ../worker/
          fi

          pnpm install --no-frozen-lockfile
          
          if [ -n "${BACKEND_USE_MAIL_WASM_PARSER}" ]; then
            pnpm add mail-parser-wasm-worker
            git apply ../.github/config/mail-parser-wasm-worker.patch
          fi

          pnpm run deploy
          echo "ğŸš€ éƒ¨ç½²æˆåŠŸï¼"

